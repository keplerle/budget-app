<header>
  <h1>Calculateur de budget</h1>
  <div>
    <button (click)="toggleTheme()"> <span class="material-icons">
        {{ isDark ? 'light_mode' : 'dark_mode' }}
      </span>
    </button>
    <button (click)="lock()"><span class="material-icons">lock</span>
    </button>
  </div>

</header>
<div class="app-container">
  @if(isLocked) {
  <div class="lock-screen">
    <div class="lock-card">
      <h2>Déverrouiller</h2>

      <input type="password" maxlength="4" [(ngModel)]="pinInput" placeholder="PIN à 4 chiffres" />

      <button (click)="unlock()">Entrer</button>
      @if(!storedPin) {
      <div class="set-pin">
        <p>Aucun code PIN défini</p>
        <button (click)="setPin()">Définir ce PIN</button>
      </div>
      }

    </div>
  </div>
  } @else {
  <div class="budget-page">
    <div class="budget-card">
      <div class="section-card">
        <div class="budget-action">
          <select [(ngModel)]="csvExportMode">
            <option value="all">Tout l’historique</option>
            <option value="month">Mois filtré</option>
          </select>

          <button class="button-action export-csv" (click)="exportCSV()"><span class="material-icons">table_view</span>
          </button>
          <button class="button-action export-pdf" (click)="exportPDF()"><span
              class="material-icons">picture_as_pdf</span>
          </button>

          <button class="button-action export-encrypted" (click)="exportEncrypted()">
            <span class="material-icons">save_as</span>

          </button>
          <input type="file" (change)="importEncrypted($event)" />
        </div>
      </div>

      <div class="budget-layout">
        <div class="column left">
          <div class="section-card">
            <h2>Objectif du mois</h2>

            <div class="goal-input">
              <input type="number" [(ngModel)]="monthlyGoal" placeholder="Objectif (€)">
              @if(monthlyGoal > 0) {
              <div class="goal-progress">
                <div class="bar">
                  <div class="fill" [style.width.%]="goalProgress"
                    [style.background]="goalProgress < 20 ? '#e53935' : '#4caf50'"></div>
                </div>

                <p>
                  Objectif : {{ monthlyGoal }} €
                  — Reste : {{ monthlyGoal - totalExpenses }} €
                  — {{ goalProgress }}%
                </p>
              </div>
              }
              <button (click)="saveGoal()">Enregistrer</button>
            </div>
          </div>
          <div class="section-card">
            <h2>Budget mensuel</h2>

            <div class="budget-input">
              <input type="number" [(ngModel)]="monthlyBudget" placeholder="Budget du mois (€)">
              @if(monthlyBudget > 0) {
              <div class="budget-progress">
                <div class="bar">

                  <div class="fill" [style.width.%]="budgetUsedPercent"
                    [style.background]="budgetUsedPercent >= 100 ? 'linear-gradient(90deg, #e53935, #ef5350)' : 'linear-gradient(90deg, #4caf50, #81c784)'">
                  </div>
                </div>

                <p>{{ totalExpenses }} € / {{ monthlyBudget }} € ({{ budgetUsedPercent }}%)</p>
              </div>
              }

              <button (click)="saveBudget()">Enregistrer</button>
            </div>
          </div>

          <div class="section-card">
            <h2>Revenu & ajout de dépense</h2>
            <h3>Revenus</h3>
            <input type="number" [(ngModel)]="income" (ngModelChange)="saveToStorage()" placeholder="Revenu mensuel" />
            <!-- revenu + formulaire ajout dépense -->
            <h3>Ajouter une dépense</h3>
            <input type="number" [(ngModel)]="expenseAmount" placeholder="Montant" />
            <select [(ngModel)]="expenseCategory">
              <option value="">Choisir une catégorie</option>
              @for (c of categories; track c) {
              <option [value]="c">{{ c }}</option>
              }
            </select>
            <input type="date" [(ngModel)]="expenseDate" placeholder="Date" />
            <button class="button-action add-expense" (click)="addExpense()">Ajouter</button>
          </div>

          <div class="section-card">
            <h2>Catégories</h2>

            <div class="category-add">
              <input type="text" [(ngModel)]="newCategory" placeholder="Nouvelle catégorie">
              <button class="button-action add-category" (click)="addCategory()">Ajouter</button>
            </div>

            <ul class="category-list">
              @for (c of categories; track c) {
              <li>
                {{ c }}
                <button class="delete-btn" (click)="removeCategory(c)">×</button>
              </li>
              }
            </ul>
          </div>
        </div>

        <div class="column right">
          <!-- résumé + liste + graphique -->
          <div id="budget-content">

            <div class="kpi-row">
              <div class="kpi-card">
                <h3>Dépenses</h3>
                <p>{{ totalExpenses }} €</p>
              </div>

              <div class="kpi-card">
                <h3>Solde</h3>
                <p>{{ balance }} €</p>
              </div>

              <div class="kpi-card">
                <h3>Transactions</h3>
                <p>{{ filteredExpenses.length }}</p>
              </div>
              <div class="kpi-row">
                <div class="kpi-card">
                  <h3>Total annuel</h3>
                  <p>{{ yearlyTotal }} €</p>
                </div>

                <div class="kpi-card">
                  <h3>Moyenne mensuelle</h3>
                  <p>{{ yearlyAverage }} €</p>
                </div>

                <div class="kpi-card">
                  <h3>Mois le plus cher</h3>
                  <p>{{ highestMonth.month }}/{{ selectedYear }} — {{ highestMonth.value }} €</p>
                </div>

                <div class="kpi-card">
                  <h3>Mois le plus léger</h3>
                  <p>{{ lowestMonth.month }}/{{ selectedYear }} — {{ lowestMonth.value }} €</p>
                </div>
              </div>


              @if(monthlyGoal > 0) {
              <div class="kpi-card">
                <h3>Objectif restant</h3>
                <p>{{ monthlyGoal - totalExpenses }} €</p>
                @if(totalExpenses > monthlyGoal) {
                <p style="color:#e53935; margin-top:8px;">
                  Objectif dépassé !
                </p>
                }


              </div>
              }
              @if(monthlyBudget > 0) {
              <div class="kpi-card">
                <h3>Budget restant</h3>
                <p>{{ monthlyBudget - totalExpenses }} €</p>
              </div>
              }
              @if(selectedMonth) {
              <div class="kpi-card">
                <h3>Évolution</h3>

                <p [style.color]="monthComparisonPercent >= 0 ? '#4caf50' : '#e53935'">
                  {{ monthComparisonPercent }}%
                </p>
              </div>
              <div class="kpi-card">
                <h3>Dépense moyenne / jour</h3>
                <p>{{ dailyAverage }} €</p>
              </div>

              <div class="kpi-card">
                <h3>Projection fin de mois</h3>
                <p [style.color]="endOfMonthProjection > monthlyBudget ? '#e53935' : '#4caf50'">
                  {{ endOfMonthProjection }} €
                </p>
                @if(monthlyBudget > 0 && endOfMonthProjection > monthlyBudget) {
                <p style="color:#e53935; margin-top:8px;">
                  ⚠️ Projection : dépassement du budget prévu !
                </p>
                }



              </div>
              }

            </div>

            <div class="section-card">
              <h2>Résumé</h2>
              <h3>Total dépenses : {{ totalExpenses }} €</h3>
              <h3>Solde restant : {{ balance }} €</h3>
            </div>

            <div class="section-card">
              <h2>Dépenses</h2>

              <h3>Filtrer par mois</h3>
              <select [(ngModel)]="selectedMonth" (change)="updateFilter()">
                <option value="">Tous les mois</option>
                @for (m of months; track m) {
                <option [value]="m.value">{{ m.label }}</option>
                }
              </select>
              <table class="expense-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Catégorie</th>
                    <th>Montant</th>
                    <th></th>
                  </tr>
                </thead>

                <tbody>
                  @for (e of filteredExpenses; track e) {
                  <tr>
                    <td>{{ e.date }}</td>

                    <td>
                      <span class="category-badge">{{ e.category }}</span>
                    </td>

                    <td class="amount-cell">
                      {{ e.amount }} €
                    </td>

                    <td class="action-cell">
                      <button class="delete-btn" (click)="removeExpense($index)">
                        <span class="material-icons">delete</span>

                      </button>
                    </td>
                  </tr>
                  }
                </tbody>
              </table>
              <h3>Répartition par catégorie</h3>
              <ul>
                @for(cat of groupedExpensesArray; track cat[0]){
                <li>
                  {{ cat[0] }} : {{ cat[1] }} €
                </li>
                }
              </ul>
            </div>

            <div class="section-card">
              <h2>Graphique des dépenses</h2>
              <div class="chart-container">
                <canvas id="expensesChart"></canvas>
              </div>
            </div>

            <div class="section-card">
              <h2>Évolution mensuelle</h2>
              <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>

            <div class="section-card">
              <h2>Évolution par catégorie</h2>

              <div class="category-trend-filter">
                <label>Catégorie :</label>
                <select [(ngModel)]="selectedCategoryForTrend" (change)="renderCategoryTrendChart()">
                  <option value="">Choisir une catégorie</option>
                  @for (c of categories; track c) {
                  <option [value]="c">{{ c }}</option>
                  }
                </select>
              </div>

              <div class="chart-container">
                <canvas id="categoryTrendChart"></canvas>
              </div>
            </div>
            <div class="section-card">
              <h2>Comparaison mois à mois</h2>

              <div class="chart-container">
                <canvas id="monthCompareChart"></canvas>
              </div>
            </div>
            <div class="section-card">
              <h2>Vue annuelle</h2>

              <div class="year-select">
                <label>Année :</label>
                <select [(ngModel)]="selectedYear" (change)="renderYearChart()">
                  @for (y of availableYears; track y) {
                  <option [value]="y">{{ y }}</option>
                  }
                </select>
              </div>

              <div class="chart-container">
                <canvas id="yearChart"></canvas>
              </div>
            </div>
            <div class="section-card">
              <h2>Projection fin de mois</h2>

              <div class="chart-container">
                <canvas id="projectionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>